---
import { db, Album, eq, Artista } from "astro:db"
import { getUserActivo } from "../Cookies/Cookies.astro"

const { infoAudio } = Astro.props

const cookies = Astro.request.headers.get('cookie')
const userActivo = await getUserActivo(cookies)

const idArtista = (await db.select({idArtista: Artista.idArtista}).from(Artista).where(eq(Artista.idUsuario, userActivo)))[0].idArtista
const albumes = await db.select({nombreAlbum: Album.nombreAlbum, idAlbum: Album.idAlbum}).from(Album).where(eq(Album.idArtista, idArtista))

---

<div id="ventanaModalEditar" class="relative z-10 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div> <!-- Backdrop -->
  
    <div class="fixed inset-0 z-10 w-full overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 w-full sm:w-full sm:max-w-lg">
            <form method="POST">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="flex flex-wrap justify-between w-full mt-3 text-left sm:mt-0">
                            <h3 class="w-full text-base sm:text-lg font-semibold leading-6 text-gray-900" id="modal-title">Editar audio</h3>
                            <div class="w-full mt-2">
                                <label class="w-full" for="nuevoNombreAudio">Título del audio <span class="text-red-600">*</span></label>
                                <input class="placeholder:text-gray-500 w-full p-1 bg-gray-300 border-2 rounded border-black" name="nuevoNombreAudio" id="nuevoNombreAudio" required>
                            </div>
                            <div class="w-full flex flex-wrap">
                                <label class="w-full" for="nuevoAutoresSecundarios">Autores secundarios</label>
                                <input class="placeholder:text-gray-500 w-full p-1 bg-gray-300 border-2 rounded border-black" name="nuevoAutoresSecundarios" id="nuevoAutoresSecundarios">
                            </div>
                            <div class="w-[30%] flex flex-wrap justify-center mt-2 items-center">
                                <label class="w-full mr-2 font-bold" for="nuevoGenero">Género <span class="text-red-600">*</span></label>
                                <select name="nuevoGenero" id="nuevoGenero" class="w-full p-1 bg-gray-300 border-2 rounded border-black" required>
                                    <option value="" disabled selected>Géneros</option>
                                    <option value="Pop">Pop</option>
                                    <option value="Regueton">Reguetón</option>
                                    <option value="Trap">Trap</option>
                                    <option value="Electronica">Electrónica</option>
                                    <option value="K-pop">K-pop</option>
                                    <option value="Country">Country</option>
                                    <option value="Rap">Rap</option>
                                    <option value="Hip-hop">Hip-hop</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                            <div class="w-[30%] flex flex-wrap justify-center mt-2 items-center">
                                <label class="w-full mr-2 font-bold" for="nuevoTipo">Tipo <span class="text-red-600">*</span></label>
                                <select name="nuevoTipo" id="nuevoTipo" class="w-full p-1 bg-gray-300 border-2 rounded border-black" required>
                                    <option value="" disabled selected>Tipos</option>
                                    <option value="cancion">Canción</option>
                                    <option value="podcast">Podcast</option>
                                </select>
                            </div>
                            <div class="w-[30%] flex flex-wrap justify-center mt-2 items-center">
                                <label class="w-full mr-2 font-bold" for="nuevoAlbum">Albúm <span class="text-red-600">*</span></label>
                                <select name="nuevoAlbum" id="nuevoAlbum" class="w-full p-1 bg-gray-300 border-2 rounded border-black" required>
                                    <option value="" disabled selected>Álbumes</option>
                                    {
                                        //Los options van a ser cada uno de los albumos del usuario
                                        albumes.map((album) => {
                                            return <option value={album.idAlbum}>{album.nombreAlbum}</option>
                                        })
                                    }
                                </select>
                            </div>
                            <div class="w-[45%] mt-2">
                                <p class="font-bold w-full">Añadir audio <span class="text-red-600">*</span></p>
                                <label for="nuevoAudioFile" class="cursor-pointer block w-max">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                                        <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 9a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V15a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25V9Z" clip-rule="evenodd" />
                                    </svg>                  
                                </label>
                                <input class="hidden" accept="audio/mp3" type="file" id="nuevoAudioFile" name="nuevoAudioFile">
                                <p id="rutaAudio">
                                    
                                </p>
                            </div>
                            <div class="w-[45%] mt-2">
                                <p class="font-bold">Añadir portada <span class="text-red-600">*</span></p>
                                <label for="nuevoImageFile" class="cursor-pointer block w-max">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                                        <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 9a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V15a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25V9Z" clip-rule="evenodd" />
                                    </svg>  
                                </label>
                                <input class="hidden" accept="image/jpg,image/png,image/webp,image/jpeg" type="file" id="nuevoImageFile" name="nuevoImageFile">
                                <img id="portadaAudio" class="w-24 h-24 mt-2" src="">
                            </div>
                            <div class="w-full flex flex-wrap">
                                <label class="w-full font-bold" for="nuevaDescripcion">Descripción</label>
                                <textarea class="placeholder:text-gray-500 w-full p-1 bg-gray-300 border-2 rounded border-black" name="nuevaDescripcion" id="nuevaDescripcion"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <input id="botonGuardar" type="submit" class="cursor-pointer inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:ml-3 sm:w-auto" data-idaudio="" value="Guardar">
                    <button id="botonCancelarGuardar" type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancelar</button>
                </div>
            </form>
        </div>
      </div>
    </div>
</div>

<script is:inline>
    document.getElementById("nuevoAudioFile").addEventListener(("input"), () => {
        const input = document.getElementById("nuevoAudioFile")

        const nombreArchivo = input.files[0].name

        document.getElementById("rutaAudio").innerText = nombreArchivo
    })

    document.getElementById("nuevoImageFile").addEventListener(("input"), () => {
        const input = document.getElementById("nuevoImageFile")

        const nombreArchivo = input.files[0]

        const preview = document.getElementById("portadaAudio")
        preview.src = URL.createObjectURL(nombreArchivo)
    })

    document.getElementById("botonCancelarGuardar").addEventListener("click", () => {
        document.getElementById("ventanaModalEditar").classList.add("hidden")
    })

    document.getElementById("botonGuardar").addEventListener("click", (e) => {
        e.preventDefault()
        console.log("Editar");
        editarAlbum(e)
    })

    async function editarAlbum(e) {
        const idAudio = e.target.dataset.idaudio
        const nuevoNombre = document.getElementById("nuevoNombreAudio").value
        const nuevoAutoresSecundarios = document.getElementById("nuevoAutoresSecundarios").value
        const nuevoGenero = document.getElementById("nuevoGenero").value
        const nuevoTipo = document.getElementById("nuevoTipo").value
        const nuevoAlbum = document.getElementById("nuevoAlbum").value
        const nuevoAudio = document.getElementById("nuevoAudioFile").value
        const nuevoPortada = document.getElementById("nuevoImageFile").value
        const nuevoDescripcion = document.getElementById("nuevaDescripcion").value
        console.log("Se editará el audio" + idAudio);

        const body = new FormData()
        body.append('idAudio', idAudio)
        body.append('nuevoNombre', nuevoNombre)
        body.append('nuevoAutoresSecundarios', nuevoAutoresSecundarios)
        body.append('nuevoGenero', nuevoGenero)
        body.append('nuevoTipo', nuevoTipo)
        body.append('nuevoAlbum', nuevoAlbum)
        body.append('nuevoAudio', nuevoAudio)
        body.append('nuevoPortada', nuevoPortada)
        body.append('nuevoDescripcion', nuevoDescripcion)

        await fetch('api/administrarArtista/updateAudio', {
            method: 'POST',
            body: body
        }).then(
            res => {
                console.log(res.status)
                window.location.reload()
            }
        ).catch(
            error => console.error(error)
        )
    }
</script>
    